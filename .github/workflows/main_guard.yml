name: ðŸ›¡ï¸ Main Guard (ç”Ÿäº§çŽ¯å¢ƒä¿é•–)

# è§¦å‘è§„åˆ™ï¼š
# 1. åªæœ‰å½“ä»£ç åˆå¹¶è¿› main (push)
# 2. æˆ–è€…é’ˆå¯¹ main å‘èµ·çš„ Pull Request æ—¶è§¦å‘
on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  # ========================================================
  # ä»»åŠ¡ä¸€ï¼šä»£ç è´¨é‡ä¸Žæž„å»ºæ£€æŸ¥ (Quality & Build)
  # ========================================================
  code-quality:
    name: ðŸ—ï¸ Quality & Build (è´¨é‡ä¸Žæž„å»º)
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Checkout Code (æ‹‰å–ä»£ç )
        uses: actions/checkout@v4

      - name: ðŸŸ¢ Setup Node.js (è®¾ç½® Node çŽ¯å¢ƒ)
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'pnpm'

      - name: ðŸ“¦ Install Dependencies (å®‰è£…ä¾èµ–)
        run: pnpm install

      - name: ðŸŽ¨ Check Formatting (æ£€æŸ¥ä»£ç ç¾Žè§‚åº¦)
        # ä½¿ç”¨ Prettier æ£€æŸ¥ï¼Œå¦‚æžœä¸ç¬¦åˆè§„èŒƒç›´æŽ¥æŠ¥é”™
        # æç¤ºï¼šå¦‚æžœè¿™é‡ŒæŠ¥é”™ï¼Œè¯·åœ¨æœ¬åœ°è¿è¡Œ npm run format
        run: npx prettier --check "src/**/*.ts"
        continue-on-error: false

      - name: ðŸ§¹ Lint Check (ä»£ç è§„èŒƒæ£€æŸ¥)
        # æ£€æŸ¥æ˜¯å¦æœ‰å¤šä½™çš„å˜é‡ã€ä¸è§„èŒƒçš„å†™æ³•
        run: pnpm run lint

      - name: ðŸ› ï¸ Type Check & Build (TSç±»åž‹æ£€æŸ¥ä¸Žæž„å»º)
        # è¿™æ˜¯æœ€å…³é”®çš„ä¸€æ­¥ï¼ŒNestJS ç¼–è¯‘å¤±è´¥å°†æ— æ³•éƒ¨ç½²
        run: pnpm run build

  # ========================================================
  # ä»»åŠ¡äºŒï¼šæ·±åº¦å®‰å…¨æ‰«æ (Deep Security Scan)
  # ========================================================
  security-audit:
    name: ðŸ‘® Security Audit (å®‰å…¨å®¡è®¡)
    runs-on: ubuntu-latest
    needs: code-quality # åªæœ‰ä»£ç è´¨é‡æ£€æŸ¥é€šè¿‡åŽæ‰è·‘å®‰å…¨æ‰«æï¼Œçœèµ„æº
    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # å…¨é‡æ‹‰å–ï¼Œä¸ºäº†æ‰«æåŽ†å²è®°å½•ä¸­çš„å¯†é’¥

      # 1. å¯†é’¥æ³„éœ²æ‰«æ (Gitleaks)
      - name: ðŸ”‘ Secret Scan (å¯†é’¥æ³„éœ²æ‰«æ)
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # 2. ä¾èµ–åŒ…æ¼æ´žæ‰«æ (NPM Audit)
      - name: ðŸ¦  Dependency Vulnerabilities (ä¾èµ–æ¼æ´žæ‰«æ)
        # æ‰«æ package-lock.jsonï¼Œå¦‚æžœæœ‰é«˜å±(high)ä»¥ä¸Šæ¼æ´žåˆ™æŠ¥é”™
        run: pnpm audit --audit-level=high

      # 3. æ–‡ä»¶ç³»ç»Ÿä¸Žé…ç½®æ¼æ´žæ‰«æ (Trivy)
      - name: ðŸ›¡ï¸ Trivy Filesystem Scan (ç”Ÿäº§æ¼æ´žæ‰«æ)
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          hide-progress: false
          format: 'table'
          exit-code: '1' # å‘çŽ°ä¸¥é‡æ¼æ´ž(CRITICAL)æ—¶è®© CI å¤±è´¥
          ignore-unfixed: true
          vuln-type: 'os,library'
          severity: 'CRITICAL,HIGH'

  # ========================================================
  # ä»»åŠ¡ä¸‰ï¼šç”Ÿæˆå‹å¥½çš„æŠ¥å‘Š (Summary)
  # ========================================================
  report-status:
    if: always() # æ— è®ºæˆåŠŸå¤±è´¥éƒ½æ‰§è¡Œ
    needs: [code-quality, security-audit]
    runs-on: ubuntu-latest
    name: ðŸ“Š Generate Report (ç”ŸæˆæŠ¥å‘Š)
    steps:
      - name: ðŸ“ Summary
        run: |
          echo "## ðŸš€ AuraLink CI Report (Main Branch)" >> $GITHUB_STEP_SUMMARY
          echo "| Check Name (æ£€æŸ¥é¡¹) | Status (çŠ¶æ€) | Note (è¯´æ˜Ž) |" >> $GITHUB_STEP_SUMMARY
          echo "| :--- | :--- | :--- |" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.code-quality.result }}" == "success" ]; then
            echo "| ðŸ—ï¸ Code Quality | âœ… Passed | TSç¼–è¯‘ä¸Žæ ¼å¼åŒ–é€šè¿‡ |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| ðŸ—ï¸ Code Quality | âŒ Failed | è¯·æ£€æŸ¥ TS ç±»åž‹é”™è¯¯æˆ– Prettier æ ¼å¼ |" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ needs.security-audit.result }}" == "success" ]; then
            echo "| ðŸ‘® Security Audit | âœ… Passed | æœªå‘çŽ°é«˜å±æ¼æ´žæˆ–å¯†é’¥æ³„éœ² |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| ðŸ‘® Security Audit | âŒ Failed | âš ï¸ å‘çŽ°å®‰å…¨éšæ‚£ï¼è¯·æŸ¥çœ‹ Security Audit è¯¦æƒ… |" >> $GITHUB_STEP_SUMMARY
          fi