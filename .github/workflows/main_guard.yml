name: ðŸ›¡ï¸ Main Guard (ç”Ÿäº§çŽ¯å¢ƒä¿é•–)

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  code-quality:
    name: ðŸ—ï¸ Quality & Build (è´¨é‡ä¸Žæž„å»º)
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4

      # ã€æ–°å¢žæ­¥éª¤ã€‘å®‰è£… pnpm
      - name: ðŸ“¦ Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9 # è¿™é‡Œå»ºè®®æŒ‡å®šä½ æœ¬åœ°ä½¿ç”¨çš„ pnpm ç‰ˆæœ¬ï¼Œæ¯”å¦‚ 8 æˆ– 9

      # ã€ä¿®æ”¹æ­¥éª¤ã€‘è®¾ç½® Node å¹¶å¼€å¯ pnpm ç¼“å­˜
      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'pnpm' # æ³¨æ„ï¼šè¿™é‡Œä»Ž npm æ”¹æˆäº† pnpm

      # ã€ä¿®æ”¹å‘½ä»¤ã€‘ä½¿ç”¨ pnpm å®‰è£…ä¾èµ–
      - name: ðŸ“¦ Install Dependencies
        run: pnpm install --frozen-lockfile

      - name: ðŸŽ¨ Check Formatting
        # ç¡®ä¿ä½ æœ‰ pnpm run format å‘½ä»¤
        run: pnpm prettier --check "src/**/*.ts"
        continue-on-error: false

      - name: ðŸ§¹ Lint Check
        run: pnpm run lint

      - name: ðŸ› ï¸ Type Check & Build
        run: pnpm run build

  security-audit:
    name: ðŸ‘® Security Audit (å®‰å…¨å®¡è®¡)
    runs-on: ubuntu-latest
    needs: code-quality
    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ”‘ Secret Scan
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # ã€æ³¨æ„ã€‘npm audit åœ¨ pnpm ä¸­å¯¹åº”çš„æ˜¯ pnpm audit
      - name: ðŸ¦  Dependency Vulnerabilities
        run: pnpm audit --audit-level=high

      - name: ðŸ›¡ï¸ Trivy Filesystem Scan
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          hide-progress: false
          format: 'table'
          exit-code: '1'
          ignore-unfixed: true
          vuln-type: 'os,library'
          severity: 'CRITICAL,HIGH'

  report-status:
    if: always()
    needs: [code-quality, security-audit]
    runs-on: ubuntu-latest
    name: ðŸ“Š Generate Report
    steps:
      - name: ðŸ“ Summary
        run: |
          echo "## ðŸš€ AuraLink CI Report (Main Branch)" >> $GITHUB_STEP_SUMMARY
          echo "| Check Name (æ£€æŸ¥é¡¹) | Status (çŠ¶æ€) | Note (è¯´æ˜Ž) |" >> $GITHUB_STEP_SUMMARY
          echo "| :--- | :--- | :--- |" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.code-quality.result }}" == "success" ]; then
            echo "| ðŸ—ï¸ Code Quality | âœ… Passed | TSç¼–è¯‘ä¸Žæ ¼å¼åŒ–é€šè¿‡ |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| ðŸ—ï¸ Code Quality | âŒ Failed | è¯·æ£€æŸ¥ TS ç±»åž‹é”™è¯¯æˆ– Prettier æ ¼å¼ |" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ needs.security-audit.result }}" == "success" ]; then
            echo "| ðŸ‘® Security Audit | âœ… Passed | æœªå‘çŽ°é«˜å±æ¼æ´žæˆ–å¯†é’¥æ³„éœ² |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| ðŸ‘® Security Audit | âŒ Failed | âš ï¸ å‘çŽ°å®‰å…¨éšæ‚£ï¼è¯·æŸ¥çœ‹ Security Audit è¯¦æƒ… |" >> $GITHUB_STEP_SUMMARY
          fi